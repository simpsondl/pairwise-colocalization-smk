
configfile: "workflow/config.yaml"


include: "rules/prepare_data.smk"


# Get all pair indices from the generated CSV
import pandas as pd
import os

PAIRS_CSV = config["OUTPUTS_DIR"] + "/pairwise_colocalization_to_perform.csv"
if os.path.exists(PAIRS_CSV):
    PAIRS = pd.read_csv(PAIRS_CSV)["pair_index"].tolist()
else:
    PAIRS = []


rule all:
    input:
        expand(
            config["OUTPUTS_DIR"] + "/coloc_{pair_index}_result.txt", pair_index=PAIRS
        ),


rule prepare_sumstats:
    input:
        pairs=config["OUTPUTS_DIR"] + "/pairwise_colocalization_to_perform.csv",
    output:
        sumstats=config["OUTPUTS_DIR"] + "/coloc_{pair_index}_sumstats.txt",
    shell:
        """
        awk -F, '$6 == "{wildcards.pair_index}"' {input.pairs} > analysis_config_{wildcards.pair_index}.txt
        bash slurm/colocalization_regions.sh preprocessed_v2 analysis_config_{wildcards.pair_index}.txt {output.sumstats} {wildcards.pair_index}
        """


rule run_coloc:
    input:
        sumstats=config["OUTPUTS_DIR"] + "/coloc_{pair_index}_sumstats.txt",
    output:
        result=config["OUTPUTS_DIR"] + "/coloc_{pair_index}_result.txt",
    shell:
        "Rscript slurm/run_coloc.R {input.sumstats} > {output.result}"
